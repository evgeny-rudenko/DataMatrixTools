select DOCNUM,
PMP,
GOOD_NAME,
KIZ,
BARCODE,GTIN, GTIN_SGTIN,SGTIN,
ID_LOT_GLOBAL , 
ID_DOCUMENT,
QUANTITY,
REMAIN_QTY

from (
select 
  DOCNUM = (SELECT top 1  isnull (doc_num,'')  from all_document where id_document_global = KIZ_ITEM.ID_DOCUMENT),
  PMP = isnull ((select INTERFIRM_MOVING.MNEMOCODE from INTERFIRM_MOVING, INTERFIRM_MOVING_ITEM
where INTERFIRM_MOVING.ID_INTERFIRM_MOVING_GLOBAL = INTERFIRM_MOVING_ITEM.ID_INTERFIRM_MOVING_GLOBAL and LOT.ID_LOT = INTERFIRM_MOVING_ITEM.ID_LOT_TO
), ''),
  GOOD_NAME = (select top 1 name from goods where goods.id_goods = lot.id_goods),
  ISNULL (
  CONVERT
    (
        VARCHAR(MAX), 
        CAST('' AS XML).value('xs:base64Binary(sql:column("BARCODE"))', 'VARBINARY(MAX)')
    ) , BARCODE)AS KIZ,
BARCODE,GTIN, GTIN_SGTIN,SGTIN,
KIZ_ITEM.ID_LOT_GLOBAL , 
KIZ_ITEM.ID_DOCUMENT,
KIZ_ITEM.QUANTITY,
REMAINS.REMAIN_QTY

 from KIZ, KIZ_ITEM,  LOT, 
 (
 select ID_KIZ_GLOBAL, MIN( REMAIN) as REMAIN_QTY
 from KIZ_2_DOCUMENT_ITEM
group by ID_KIZ_GLOBAL
 ) REMAINS
where KIZ.ID_KIZ_GLOBAL = KIZ_ITEM.ID_KIZ_GLOBAL
and lot.ID_LOT_GLOBAL = KIZ_ITEM.ID_LOT_GLOBAL
and REMAINS.ID_KIZ_GLOBAL = KIZ.ID_KIZ_GLOBAL
and REMAINS.REMAIN_QTY >0
) a 
